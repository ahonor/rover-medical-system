name: Rover Medical System - CI/CD

on:
  push:
    branches: ["main"]

  workflow_dispatch:
    inputs:
      release:
        description: "Demo release to run (release-1, release-2, release-3...)"
        required: true
        default: "release-1"
      nape_version:
        description: "NAPE CLI version to install"
        required: false
        default: 1.1.0

jobs:
  assured_release:
    runs-on: ubuntu-latest

    env:
      # Default release when this runs from a push (no inputs context)
      RELEASE: ${{ inputs.release || 'release-1' }}
      SUBJECT_ID: ${{ github.run_id }}

    steps:
      - name: Checkout source
        uses: actions/checkout@v4

      - name: Resolve release
        id: rel
        uses: ./.github/actions/determine-release

      - name: Show release
        run: |
          set -euo pipefail
          echo "Release output is: ${{ steps.rel.outputs.release }}"
          echo "RELEASE env var is: ${RELEASE}"

      - name: Install NAPE CLI
        uses: ./.github/actions/setup-nape
        with:
          version: 1.1.0

      - name: NAPE - Start Evidence Collection
        shell: bash
        run: |
          set -euo pipefail

          SUBJECT_ID=$(date +%s%3N)

          nape collect start \
            --subject "nrn:procedure:rover-medical/rover-medicine-system"  \
            --subject-id "$SUBJECT_ID" \
            --procedure-link "https://github.com/attestify/rover-medical-catalog.git" \
            --procedure-directory "rover-mediical-system/${RELEASE}" \
            --meta system-owner "Bill Bensing"

          nape collect evidence \
            --control-activity "pet-medicine-app" \
            --file-path "pet-medicine-app/app-config.toml"

          nape collect report
